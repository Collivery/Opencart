<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Collivery.net Extension For Opencart v3.0.3.x</name>
    <code>mds</code>
    <!--  Also modify Collivery.php::PLUGIN_VERSION -->
    <version>1.2.2</version>
    <author>MDS Technologies</author>
    <link>https://collivery.net</link>
    <!-- CONTROLLERS -->
    <!-- Admin Controllers -->
    <file path="catalog/controller/checkout/shipping_method.php">
        <operation>
            <search>
                <![CDATA[if (isset($this->session->data['shipping_methods'])) {]]>
            </search>
            <add position="before">
                <![CDATA[

        $collivery_method_available = false;
		foreach ($this->session->data['shipping_methods'] as $method_array){
		    if(isset($method_array['code']) && $method_array['code'] === 'mds' && count($method_array['quote'])) {
                $collivery_method_available = true;
                break;
            }

        }
		if($collivery_method_available){
            $data['error_warning'] = 'No Collivery.net Shipping Methods Available!';
        }

                ]]>
            </add>
        </operation>

    </file>
    <file path="admin/controller/startup/startup.php|catalog/controller/startup/startup.php">
        <operation>
            <search>
                <![CDATA[$this->registry->set('encryption', new Encryption($this->config->get('config_encryption')));]]>
            </search>
            <add position="after">
                <![CDATA[

        /** @collivery-config */
        $colliveryLibrary = DIR_SYSTEM.'library/mds/Collivery.php';
        if (is_file($colliveryLibrary)) {
            include_once $colliveryLibrary;
            $collivery = new \Mds\Collivery($this->registry);
            if ($collivery->authenticate() && $collivery->isAuthError()) {
                $this->registry->set('error', ['warning' => 'Collivery.net Shipping Plugin Login Error']);
            }

            $this->registry->set('collivery', $collivery);
        }
        /** @endcollivery-config */

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/model/checkout/order.php">
        <operation>
            <search>
                <![CDATA[public function addOrder($data) {]]>
            </search>
            <add position="after">
                <![CDATA[

        /** @collivery-data */
        if($this->collivery){
            $default_address =  $this->collivery->getDefaultAddress();
            $sql_data['collivery_from_address_id'] = $default_address['address']['address_id'];
            $sql_data['collivery_from_contact_id'] = current($default_address['contacts'])['contact_id'];

            if(isset($data['shipping_collivery_location_type'], $data['shipping_collivery_town'], $data['shipping_collivery_suburb'])){
                $sql_data['collivery_location_type'] = $data['shipping_collivery_location_type'];
                $sql_data['collivery_town'] = $data['shipping_collivery_town'];
                $sql_data['collivery_suburb'] = $data['shipping_collivery_suburb'];
            }
            $extra_sql = '';
            foreach($sql_data as $column => $value){
                $extra_sql .= $column ."='" . $value . "',";
            }
        }

        /** @endcollivery-data */

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA["INSERT INTO `" . DB_PREFIX . "order` SET]]>
            </search>
            <add position="replace">
                <![CDATA[
                "INSERT INTO `" . DB_PREFIX . "order` SET {$extra_sql}
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/confirm.php">
        <operation>
            <search>
                <![CDATA[$this->load->model('account/customer');]]>
            </search>
            <add position="replace">
                <![CDATA[

                    $this->load->model('account/customer');
                    $this->load->model('account/address');

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$order_data['shipping_country_id'] = $this->session->data['shipping_address']['country_id'];]]>
            </search>
            <add position="replace">
                <![CDATA[

                $order_data['shipping_country_id'] = $this->session->data['shipping_address']['country_id'];
				$order_data['shipping_collivery_town'] = $this->session->data['shipping_address']['collivery_town'];
				$order_data['shipping_collivery_suburb'] = $this->session->data['shipping_address']['collivery_suburb'];
				$order_data['shipping_collivery_location_type'] = $this->session->data['shipping_address']['collivery_location_type'];

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/guest.php">
        <operation>
            <search>
                <![CDATA[$this->session->data['shipping_address']['zone_id'] = $this->request->post['zone_id'];]]>
            </search>
            <add position="replace">
                <![CDATA[

                $this->session->data['shipping_address']['zone_id'] = $this->request->post['zone_id'];
				$this->session->data['shipping_address']['collivery_town'] = isset($this->request->post['collivery_town'])
				? $this->request->post['collivery_town']
				: null;
				$this->session->data['shipping_address']['collivery_suburb'] = isset($this->request->post['collivery_suburb'])
				? $this->request->post['collivery_suburb']
				: null;
				$this->session->data['shipping_address']['collivery_location_type'] = isset($this->request->post['collivery_location_type'])
				? $this->request->post['collivery_location_type']
				: null;

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$this->session->data['guest']['telephone'] = $this->request->post['telephone'];]]>
            </search>
            <add position="replace">
                <![CDATA[

                   $this->session->data['guest']['telephone'] = $this->request->post['telephone'];
                    /** @collivery-data */
                    $this->session->data['guest']['collivery_town'] = isset($this->request->post['collivery_town'])
                    ? $this->request->post['collivery_town']
                    : null;
                    $this->session->data['guest']['collivery_suburb'] = isset($this->request->post['collivery_suburb'])
                    ? $this->request->post['collivery_suburb']
                    : null;
                    $this->session->data['guest']['collivery_location_type'] = isset($this->request->post['collivery_location_type'])
                    ? $this->request->post['collivery_location_type']
                    : null;

                    /** @endcollivery-data */

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/guest.php|catalog/controller/checkout/register.php">
        <operation>
            <search>
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields($customer_group_id);]]>
            </search>
            <add position="replace">
                <![CDATA[
                $custom_fields = $this->model_account_custom_field->getCustomFields();
                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/controller/sale/order.php">
        <operation>
            <search>
                <![CDATA[public function add() {]]>
            </search>
            <add position="before">
                <![CDATA[

   public function createColliveryAddress()
{
    $order_id = $this->request->get['order_id'];
    if($order_id){
        $order_object = (object) $this->db->query('select * from '. DB_PREFIX . "order where order_id='".$this->db->escape($order_id)."'")->row;
        $post_data = (object) $this->request->post;
        if(!$order_object->waybill_id || ($order_object->collivery_town != $post_data->shipping_collivery_town || $order_object->collivery_suburb != $post_data->shipping_collivery_suburb)){ //if address is not created
            $address_data['street'] = $order_object->shipping_address_1;
            $address_data['location_type'] = $post_data->shipping_collivery_location_type;
            $address_data['suburb_id'] = $post_data->shipping_collivery_suburb;
            $address_data['town_id'] = $post_data->shipping_collivery_town;
            $address_data['custom_id'] = $order_object->customer_id;
            $address_data['full_name'] = $order_object->firstname . ' ' . $order_object->lastname;
            $address_data['cellphone'] = $order_object->telephone;
            $address_data['phone'] = $order_object->telephone;
            $address_data['email'] = $order_object->email;

            $results = $this->collivery->addAddress($address_data);

            if (!isset($results['address_id'])) {
                $output = "";
                foreach((array) $results['errors'] as $error) {
                    $output .= $error.PHP_EOL;
                }

                $this->response->addHeader($this->request->server['SERVER_PROTOCOL'] . '/1.1 400 Bad Request');
                $this->response->addHeader('Content-Type: application/json');
                $this->response->setOutput(json_encode(['errors' => $output]));

                return;
            }

            list('address_id' => $address_id, 'contact_id' => $contact_id) = $results;
            $this->db->query('update ' .DB_PREFIX . 'order set collivery_town="'. $this->db->escape($address_data['town_id']). '", collivery_suburb="'. $this->db->escape($address_data['suburb_id']). '", collivery_location_type="'. $this->db->escape($address_data['location_type']). '", collivery_to_address_id="' . $this->db->escape($address_id) .'", collivery_to_contact_id="' . $this->db->escape($contact_id) . '" where order_id="' . $this->db->escape($order_object->order_id) . '"');
        }

        if($this->config->get('shipping_mds_auto_create_waybill') == 1){
            $this->acceptAndCreateWaybill($order_id);
        }
        else
        {
            $data = $this->db->query("select * from " . DB_PREFIX . "order where order_id='" . $this->db->escape($order_id) . "'")->row;

            $waybill_id = null;
            $waybill_status = '';
            $response['delivery_date'] = 'N/A';
            $response['waybill_status'] = 'N/A';
            if(is_array($waybill_status)){
                if(array_key_exists('status_text', $waybill_status)){
                    $response['waybill_status'] = $waybill_status['status_text'];
                }
                if(array_key_exists('delivery_date', $waybill_status)){
                    $response['delivery_date'] = $waybill_status['delivery_date'];
                }
            }
            $response['waybill_id'] = $waybill_id;
            $response['waybill_service'] = $data['shipping_method'];
            $response['collivery_from'] = $this->collivery->getAddress($data['collivery_from_address_id'])['nice_address'];
            $response['collivery_to'] = $this->collivery->getAddress($data['collivery_to_address_id'])['nice_address'];

            $this->response->addHeader('Content-Type: application/json');
            $this->response->setOutput(json_encode($response));
        }
    }
}

public function changeFromAddress(){
    $order_id = $this->request->get['order_id'];
    $address_id = $this->request->get['address_id'];
    $this->db->query('update ' .DB_PREFIX . "order set `collivery_from_address_id`='". $this->db->escape($address_id)."' where order_id='" . $this->db->escape($order_id) . "'");
    $this->acceptAndCreateWaybill($order_id);
}

public function acceptAndCreateWaybill($order_id)
{
    $data = $this->db->query("select * from " . DB_PREFIX . "order where order_id='".$this->db->escape($order_id)."'")->row;
    if($data['collivery_from_address_id'] && $data['collivery_to_address_id']){ //if waybill is not created
        $data_object = (object) $data;
        $quote['parcels'] = [];
        $quote['collivery_from'] = $data_object->collivery_from_address_id;
        $quote['contact_from'] = $data_object->collivery_from_contact_id;
        $this->load->model('sale/order');
        $this->load->model('catalog/product');
        $order_products = $this->model_sale_order->getOrderProducts($data['order_id']);
        foreach ($order_products as $key => $order_product){
            $product_model = (object) $order_product;
            $product = (object) $this->model_catalog_product->getProduct($product_model->product_id);
            $quote['parcels'][$key]['width'] = $product->width;
            $quote['parcels'][$key]['height'] = $product->height;
            $quote['parcels'][$key]['length'] = $product->length;
            $quote['parcels'][$key]['weight'] = $product->weight;
        }
        list(1 => $service_type_id) = explode('.', $data['shipping_code']);
        $quote['collivery_to'] = $data_object->collivery_to_address_id;
        $quote['contact_to'] = $data_object->collivery_to_contact_id;
        $quote['service'] = $service_type_id;
        $quote['collivery_type'] = 2; //package
        $quote['cover'] = $this->config->get('shipping_mds_cover');
        $quote['rica'] = $this->config->get('shipping_mds_rica');
        $validated_collivery_data = $this->collivery->validate($quote);
        if($validated_collivery_data){
            $data['quote_data'] = $validated_collivery_data;
            $check = $this->db->query('select waybill_id from ' .DB_PREFIX . 'order where order_id="' . $this->db->escape($data_object->order_id) . '"')->row['waybill_id'];
            if(!$check) {
                try {
                    $waybill_id = $this->collivery->addCollivery($validated_collivery_data);
                    $this->db->query('update ' .DB_PREFIX . "order set `collivery_price_data`='". json_encode($validated_collivery_data)."', waybill_id='" . $this->db->escape($waybill_id) . "' where order_id='" . $this->db->escape($data_object->order_id) . "'");
                    if($this->config->get('shipping_mds_auto_accept_waybill')==1){
                        $this->collivery->acceptCollivery($waybill_id);
                    }
                } catch (\Mds\ColliveryException $e) {
                    $this->response->addHeader($this->request->server['SERVER_PROTOCOL'] . '/1.1 400 Bad Request');
                    $this->response->addHeader('Content-Type: application/json');
                    $this->response->setOutput(json_encode(['errors' => $e->getMessage()]));

                    return;
                }
            }
        }
    }

    $data = $this->db->query("select * from " . DB_PREFIX . "order where order_id='" . $this->db->escape($order_id) . "'")->row;

    $waybill_id = $data['waybill_id'];
    $waybill_status = $this->collivery->getColliveryStatus($waybill_id);
    $response['delivery_date'] = 'N/A';
    $response['waybill_status'] = 'N/A';
    if(is_array($waybill_status)){
        if(array_key_exists('status_text', $waybill_status)){
            $response['waybill_status'] = $waybill_status['status_text'];
        }
        if(array_key_exists('delivery_date', $waybill_status)){
            $response['delivery_date'] = $waybill_status['delivery_date'];
        }
    }
    $response['waybill_id'] = $waybill_id;
    $response['waybill_service'] = $data['shipping_method'];
    $response['collivery_from'] = $this->collivery->getAddress($data['collivery_from_address_id'])['nice_address'];
    $response['collivery_to'] = $this->collivery->getAddress($data['collivery_to_address_id'])['nice_address'];

    $this->response->addHeader('Content-Type: application/json');
    $this->response->setOutput(json_encode($response));
}

                ]]>
            </add>
        </operation>

        <operation>
            <search index="1">
                <![CDATA[$this->load->model('localisation/order_status');]]>
            </search>
            <add position="before">
                <![CDATA[

    /** @collivery-data */
        list($code, $service_type_id) = explode('.', $data['shipping_code']);
        $data['is_mds'] = $code == 'mds';
        $location_types = $this->collivery->getLocationTypes();
        $towns = $this->collivery->getTowns();
        $suburbs = $this->collivery->getAllSuburbs();

        if($data['is_mds']){

            $data['addresses']  = $this->collivery->getAddresses();
            $data['default_address_id'] = $this->config->get('shipping_mds_default_address_id');

            $data['collivery_services'] = $this->collivery->getServices();

            $order = $this->db->query('select * from ' . DB_PREFIX . 'order where order_id="' . $this->db->escape($data['order_id']).'"')->row;

            foreach ($order as $column => $column_value){
                $data[$column] = $column_value;
            }

            if($data['collivery_from_address_id']){
            $data['default_address_id'] = $data['collivery_from_address_id'];
            }

            if(!$data['collivery_from_address_id']){
                $address = $this->collivery->getDefaultAddress();
                list('address_id' => $address_id) = $address['address'];
                list('contact_id' => $contact_id) = current($address['contacts']);
                $data['collivery_from_address_id'] = $address_id;
                $this->db->query('update ' .DB_PREFIX . 'order set collivery_from_address_id="' . $this->db->escape($address_id) . '", collivery_from_contact_id="' . $this->db->escape($contact_id) .'" where order_id="' . $this->db->escape($data['order_id']) . '"');
            }

            //Collivery collection address
            if($data['collivery_from_address_id']){
                $data['collivery_collection_address'] = $this->collivery->getAddress($data['collivery_from_address_id']);
            }
            //Collivery delivery address
            if($data['collivery_to_address_id']){
                $data['collivery_delivery_address'] = $this->collivery->getAddress($data['collivery_to_address_id']);
            }


            $data['waybill_service_name'] = $data['collivery_services'][$service_type_id];
            $data['waybill_service_id'] = $service_type_id;

            $order_products = $this->model_sale_order->getOrderProducts($data['order_id']);
            $this->load->model('catalog/product');

            $data['order_products'] = $order_products;
            if(!$data['waybill_id'] && $data['collivery_from_address_id'] && $data['collivery_to_address_id']){ //if waybill is not created
                $data_object = (object) $data;
                $quote['parcels'] = [];
                $quote['collivery_from'] = $data_object->collivery_from_address_id;
                $quote['contact_from'] = $data_object->collivery_from_contact_id;
                foreach ($order_products as $key => $order_product){
                    $product_model = (object) $order_product;
                    $product = (object) $this->model_catalog_product->getProduct($product_model->product_id);
                    $quote['parcels'][$key]['width'] = $product->width;
                    $quote['parcels'][$key]['height'] = $product->height;
                    $quote['parcels'][$key]['length'] = $product->length;
                    $quote['parcels'][$key]['weight'] = $product->weight;
                }
                $quote['collivery_to'] = $data_object->collivery_to_address_id;
                $quote['contact_to'] = $data_object->collivery_to_contact_id;
                $quote['service'] = $service_type_id;
                $quote['collivery_type'] = 2; //package
                $quote['cover'] = $this->config->get('mds_shipping_cover');
                $quote['rica'] = $this->config->get('mds_shipping_rica');
                $validated_collivery_data = $this->collivery->validate($quote);
                if($validated_collivery_data){
                    $data['quote_data'] = $validated_collivery_data;
                }
            }


            if($data['collivery_town']){
                $data['town'] = $towns[$data['collivery_town']];
            }
            if(!empty($suburbs) && isset($data['collivery_suburb'])){
                $data['suburb'] = $suburbs[$data['collivery_suburb']];
            }
            if($data['collivery_location_type']){
                $data['location_type'] = $location_types[$data['collivery_location_type']];
            }
            if($data['waybill_id']){
                $data['waybill_status'] = $this->collivery->getStatus($data['waybill_id']);
                $data['waybill_pod'] = $this->collivery->getPod($data['waybill_id']);
                $data['waybill_enc'] = (string) base64_encode ($data['waybill_id']);
            }
        }
        /** @endcolivery-data */

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function getForm() {]]>
            </search>
            <add position="after">
                <![CDATA[

                    $this->load->language('extension/shipping/mds', 'collivery_lang');
                    $data = $this->language->all();

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/checkout.php">
        <operation>
            <search>
                <![CDATA[public function country() {]]>
            </search>
            <add position="before">
                <![CDATA[

                    public function getTownSuburbs() {
                        $townId = $this->request->get['town_id'];
                        $respond = "";

                        foreach ($this->collivery->getSuburbs($townId) as $key => $sub) {
                            $respond .= '<option value="'.$key.'">'. $sub .'</option>';
                        }
                        echo $respond;
                    }

                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/controller/sale/customer.php">
        <operation>
            <search>
                <![CDATA[public function transaction() {]]>
            </search>
            <add position="before">
                <![CDATA[

                    public function getTownSuburbs() {
                        $townId = $this->request->get['town_id'];
                        $respond = "";
                        foreach ($this->collivery->getSuburbs($townId) as $key => $sub) {
                            $respond .= '<option value="'.$key.'">'. $sub .'</option>';
                        }
                        echo $respond;
                    }

                ]]>
            </add>
        </operation>
    </file> <!-- !exist() -->
    <!-- End Admin Controllers -->
    <!-- Catalog Controllers -->

    <file path="catalog/model/account/address.php">
        <operation>
            <search>
                <![CDATA['address_id'     => $address_query->row['address_id'],]]>
            </search>
            <add position="replace">
                <![CDATA[

                'address_id'     => $address_query->row['address_id'],
				'collivery_town'     => $address_query->row['collivery_town'],
				'collivery_suburb'     => $address_query->row['collivery_suburb'],
				'collivery_location_type'     => $address_query->row['collivery_location_type'],

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function editAddress($address_id, $data) {]]>
            </search>
            <add position="after">
                <![CDATA[

                    $sql['collivery_town'] = $data['collivery_town'];
                    $sql['collivery_suburb'] = $data['collivery_suburb'];
                    $sql['collivery_location_type'] = $data['collivery_location_type'];
                    $string = '';
                    foreach($sql as $k => $v){
                        $string .= "$k='$v', ";
                    }

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA["UPDATE " . DB_PREFIX . "address SET]]>
            </search>
            <add position="replace">
                <![CDATA[
                "UPDATE " . DB_PREFIX . "address SET $string
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function addAddress($customer_id, $data) {]]>
            </search>
            <add position="after">
                <![CDATA[

        $sql['collivery_location_type'] = $data['collivery_location_type'];
        $sql['collivery_town'] = $data['collivery_town'];
        $sql['collivery_suburb'] = $data['collivery_suburb'];
        $string = '';
        foreach($sql as $k => $v){
            $string .= "$k='$v', ";
        }

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA["INSERT INTO " . DB_PREFIX . "address SET]]>
            </search>
            <add position="replace">
                <![CDATA[
                "INSERT INTO " . DB_PREFIX . "address SET $string
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/account/address.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="before">
                <![CDATA[
                //if($custom_field['name'] == 'Town' || $custom_field['name'] == 'Suburb' || $custom_field['name'] == 'Location Type')continue;
            ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/shipping_address.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[

                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/payment_address.php">
        <operation>
            <search>
                <![CDATA[$address_id = $this->model_account_address->addAddress($this->customer->getId(), $this->request->post);]]>
            </search>
            <add position="after">
                <![CDATA[

                    /** @collivery-data */
                    $this->session->data['collivery_collection_address'] = $this->db->query("select * from " . DB_PREFIX . "address where address_id='" . $this->db->escape($address_id) . "'")->row;
                    /** @endcollivery-data */

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[

                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/payment_address.php|catalog/controller/checkout/shipping_address.php">
        <operation>
            <search index="1">
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields($this->config->get('config_customer_group_id'));]]>
            </search>
            <add position="replace">
                <![CDATA[

                   $custom_fields = $this->model_account_custom_field->getCustomFields();

                ]]>
            </add>
        </operation>
        <operation>
            <search index="1">
                <![CDATA[if (!$json) {]]>
            </search>
            <add position="before">
                <![CDATA[

        /** @collivery-data */
        if(isset($this->request->post['address_id'])){
            $address_id = $this->request->post['address_id'];
            $result = $this->db->query("select collivery_town, collivery_suburb, collivery_location_type from " . DB_PREFIX . "address where address_id='" . $this->db->escape($address_id) . "'");
            if($result->num_rows){
                $address = (object) $result->row;
                if(!$address->collivery_town || !$address->collivery_suburb || !$address->collivery_location_type){
                    //redirect
                    $json['redirect'] =  "index.php?route=account/address/edit&address_id=$address_id";
                }
            }
        }
        /** @endcollivery-data */

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[

                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {

                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/account/register.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[

                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/api/payment.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['required'] && empty($this->request->post['custom_field'][$custom_field['location']][$custom_field['custom_field_id']])) {]]>
            </search>
            <add position="replace">
                <![CDATA[

                    if ($custom_field['required'] && empty($this->request->post['custom_field'][$custom_field['custom_field_id']])) {

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/api/shipping.php|catalog/controller/api/payment.php">
        <operation>
            <search>
                <![CDATA[if (if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="before">
                <![CDATA[
                if($custom_field['name'] == 'Town' || $custom_field['name'] == 'Suburb' || $custom_field['name'] == 'Location Type'){continue;}
                ]]>
            </add>
        </operation>

    </file>
    <file path="catalog/controller/api/shipping.php">
        <operation>
            <search>
                <![CDATA['firstname'      => $this->request->post['firstname'],]]>
            </search>
            <add position="replace">
                <![CDATA[

                    'firstname'      => $this->request->post['firstname'],
                    'collivery_town'      => $this->request->post['shipping_collivery_town'],
                    'collivery_location_type'      => $this->request->post['shipping_collivery_location_type'],

                ]]>
            </add>
        </operation>

    </file>
    <file path="admin/model/sale/order.php">
        <operation>
            <search>
                <![CDATA['order_id'                => $order_query->row['order_id'],]]>
            </search>
            <add position="replace">
                'order_id' => $order_query->row['order_id'],
                'waybill_id' => $order_query->row['waybill_id'],
            </add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.twig">
        <operation>
            <search>
                <![CDATA[: $('a[href=\'#tab-shipping\']')]]>
            </search>
            <add position="replace">
                <![CDATA[
                : $('a[href=\'#tab-mds\']')
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$('#button-shipping-address').button('reset');]]>
            </search>
            <add position="replace">
                <![CDATA[
                //$('#button-shipping-address').button('reset');
                ]]>
            </add>
        </operation>
        <operation>
            <search index="1">
                <![CDATA[$('a[href=\'#tab-total\']').tab('show');]]>
            </search>
            <add position="replace">
                <![CDATA[
                var url = (new URL(window.location.href));
                var user_token = user_token || url.searchParams.get('user_token');
                var colliveryElements = $(document)
                  .find('[name="shipping_collivery_town"], [name="shipping_collivery_suburb"], [name="shipping_collivery_location_type"]');
                var errors = [];
                colliveryElements.each(function () {
                  if (!$(this).val()) {
                    alert('Please select Town, Suburb and Location Type');
                    errors.push($(this).attr('name')+' missing!');
                  }
                });
                if (!errors.length) {
                  $.ajax({
                    url: 'index.php?route=sale/order/createColliveryAddress&user_token='+user_token+'&order_id={{ order_id }}',
                    method: 'post',
                    dataType: 'json',
                    data: $('#tab-shipping').find('select, textarea, input').serialize()
                  })
                  .done(function (response) {
                    var waybill_id = response.waybill_id;
                    if(waybill_id!=null){
                    var waybill_service = response.waybill_service;
                    var collivery_from = response.collivery_from;
                    var collivery_to = response.collivery_to;
                    var delivery_date = response.delivery_date;
                    var html = '<div class="row">' +
                        '  <div class="col-md-4 text-left">' +
                        '      <h4>' +
                        '          Waybill No: ' + waybill_id + ' <b></b>' +
                        '      </h4>' +
                        '  </div>' +
                        '  <div class="col-md-4 text-center">' +
                        '      <h4>' +
                        '          Service Type: ' + waybill_service + '<b></b>' +
                        '      </h4>' +
                        '  </div>' +
                        '  <div class="col-md-4 text-right">' +
                        '      <h4>' +
                        '          Delivery Date : ' + delivery_date + '<b></b>' +
                        '      </h4>' +
                        '    </div>' +
                        '</div>' +
                        '<div class="row">' +
                        '  <div class="col-md-12">' +
                        '    <table class="table table-bordered">' +
                        '      <tbody>' +
                        '        <tr>' +
                        '          <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>' +
                        '        </tr>' +
                        '        <tr>' +
                        '          <td width="50%" class="text-center"><b>Collection Address</b></td>' +
                        '          <td width="50%" class="text-center"><b>Delivery Address</b></td>' +
                        '        </tr>' +
                        '        <tr>' +
                        '          <td>' + collivery_from + '</td>' +
                        '          <td>' + collivery_to + '</td>' +
                        '        </tr>' +
                        '      </tbody>' +
                        '    </table>' +
                        '  </div>' +
                        '</div>';
                    $(document).find('#sub-tab-mds').html(html);
                    }
                  })
                  .fail(function(jqXHR, textStatus, errorThrown ) {
                    console.error(jqXHR, textStatus, errorThrown);

                    // The web server (apache, haproxy) returned an error page
                    if (jqXHR.responseText.substr(0,1) === '<') {
                      alert('Server error, please check error logs');
                    } else {
                      var text = JSON.parse(jqXHR.responseText);
                      alert(text.errors);
                    }
                  })
                  .always(function () {
                    $('a[href="#tab-mds"]').tab('show');
                    $('#button-shipping-address').button('reset');
                  });
                }


                ]]>
            </add>
        </operation>
        <operation>
            <search index="0">
                <![CDATA[</script>]]>
            </search>
            <add position="after">
                <![CDATA[

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[<li class="disabled"><a href="#tab-total" data-toggle="tab">5. {{ tab_total }}</a></li>]]>
            </search>
            <add position="replace">
                <![CDATA[

                    <li class="disabled">
                        <a href="#tab-mds" data-toggle="tab">
                            5. {{ collivery_lang.get('tab_collivery') }}
                        </a>
                    </li>
                    <li class="disabled">
                        <a href="#tab-total" data-toggle="tab">
                            6. {{ tab_total }}
                        </a>
                    </li>

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[return false;]]>
            </search>
            <add position="replace">
                <![CDATA[
                return false;
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[<div class="tab-pane" id="tab-total">]]>
            </search>
            <add position="before">
                <![CDATA[

            <div class="tab-pane" id="tab-mds">
   <div class="row">
      <div class="col-md-12 text-center">
         <img width="20%" alt="Collivery Logo" class="center" src="https://collivery.net/img/collivery.net-logo.svg" />
         <hr/>
      </div>
   </div>
   <div id="sub-tab-mds">
      {% if is_mds %}
      <div class="row">
         <div class="col-md-12">
            <table class="table table-bordered">
               <tbody>
                  <tr>
                     <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>
                  </tr>
                  <tr>
                     <td class="text-center"><b>Collection Address</b></td>
                     {% if collivery_delivery_address is not empty  %}
                     <td class="text-center"><b>Delivery Address</b></td>
                     {% else %}
                     <td>Town</td>
                     <td>Suburb</td>
                     <td>Location Type</td>
                     {% endif %}
                  </tr>
                  <tr>
                     <td>
                     {% if addresses is not empty  %}
                            <select class="form-control" id="shipping_mds_default_address_id" name="shipping_mds_default_address_id">
                                {% for address_id, address in addresses %}
                                    <option {{ address_id == default_address_id ? 'selected' : '' }} value="{{ address_id }}">{{ address.nice_address }}</option>
                                {% endfor %}
                            </select>
                            <br>
                            <br>
                            <button class="btn btn-success" id="changeFromAddress">Select Address</button>
                     {% else %}   {{ collivery_collection_address.nice_address }}</td>{% endif %}
                     {% if collivery_delivery_address is not empty %}
                     <td>{{ collivery_delivery_address.nice_address }}</td>
                     {% else %}
                     <td>{{ town }}</td>
                     <td>{{ suburb }}</td>
                     <td>{{ location_type }}</td>
                     {% endif %}
                  </tr>
                  <tr>
                     <td class="text-center text-uppercase bg-warning" colspan="9">Collivery Status</td>
                  </tr>
               </tbody>
            </table>
         </div>
      </div>
      <div class="row">
         <div class="col-md-12">
          {% if is_mds and waybill_status == 1 %}
            <button class="btn btn-success" id="accept-waybill">Accept Waybill (start shipping)</button>
          {% else %}
            <table class="table table-striped">
               <thead>
                  <tr>
                     <td>Status</td>
                     <td>Delivery Date</td>
                     <td>ETA</td>
                  </tr>
               </thead>
               <tbody>
                  <tr>
                     <td>{{ waybill_info.status_text }}</td>
                     <td>{{ waybill_info.delivery_date }}</td>
                     <td>{{ waybill_info.eta_text }}</td>
                  </tr>
               </tbody>
            </table>
          {% endif %}
         </div>
      </div>
      {% else %}
      <div class="row">
         <div class="col-md-12">
            <br>
            <br>
            <h5 class="text-center text-info text-uppercase">Please not that the customer did not use Collivery.net shipping method</h5>
         </div>
      </div>
      {%  endif %}
   </div>
   <div class="row">
      <div {% if  not waybill_id and is_mds %} }} class="col-md-6 text-left" {% else %} class="col-md-6 text-left" {% endif %}>
      <button onclick="$('select[name=\'shipping_method\']').prop('disabled') ? $('a[href=\'#tab-payment\']').tab('show') : $('a[href=\'#tab-shipping\']').tab('show');" type="button"  class="btn btn-default"><i class="fa fa-arrow-left"></i>
      {{ button_back }}
      </button>
   </div>
   <div {% if  not waybill_id and is_mds %} }} class="col-md-6" {% else %} class="col-md-6" {% endif %}>
   <button type="button" id="button-mds-shipping" data-loading-text="{{ text_loading }}" class="pull-right btn btn-primary"><i class="fa fa-arrow-right"></i>
   {{ button_continue }}
   </button>
</div>
</div>
</div>

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[[data: $('#tab-payment input[type=\'text\'], #tab-payment input[type=\'hidden\'], #tab-payment input[type=\'radio\']:checked, #tab-payment input[type=\'checkbox\']:checked, #tab-payment select, #tab-payment textarea'),]]>
            </search>
            <add position="replace">
                <![CDATA[
                [
                    data: $('body').find('textarea, input, select').serialize(),

                ]]>
            </add>
        </operation>
    </file>
    <!-- End Admin Views -->
    <!-- Catalog views -->
    <file path="catalog/view/theme/*/template/checkout/checkout.twig|catalog/view/theme/*/template/account/address_form.twig">
        <operation>
            <search index="0">
                <![CDATA[</script>]]>
            </search>
            <add position="after">
                <![CDATA[

                <script type="text/javascript">
                   $(document)
                .on('change', '[name="collivery_town"]', function() {
                  var elem = $(this);
                  var townId = elem.val();
                  $(document).find('[name="city"]')
                    .val(elem.find('option:selected').text());

                  var url = 'index.php?route=checkout/checkout/getTownSuburbs&town_id='+townId;
                  $.get(url)
                  .done(function(response){
                    if($(response).attr('value') !== 'auth'){
                      $('[name="collivery_suburb"]').empty().html(response);
                    } else if(!$(document).find('#collivery-alert').length){
                      $('fieldset').prepend('<div id="collivery-alert" class="alert alert-danger"><strong>Collivery.net</strong> Please contact admin to fix Collivery.net shipping extension.</div>');
                      console.error('Collivery Shipping Plugin Could Not Authenticate');
                    }
                  }).fail(function(jqXHR, textStatus, errorThrown ) {
                    console.error(jqXHR, textStatus, errorThrown);

                    // The web server (apache, haproxy) returned an error page
                    if (jqXHR.responseText.substr(0,1) === '<') {
                      alert('Server error, please check error logs');
                    } else {
                      var text = JSON.parse(jqXHR.responseText);
                      alert(text.errors);
                    }
                  });
                }).ready(function(){
                  $(document).find('[name="city"]').closest('.form-group').attr('hidden', true)
                });
                </script>

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/view/theme/*/template/checkout/guest.twig|catalog/view/theme/*/template/checkout/guest_shipping.twig|catalog/view/theme/*/template/checkout/register.twig|catalog/view/theme/*/template/checkout/shipping_address.twig|catalog/view/theme/*/template/checkout/payment_address.twig|catalog/view/theme/*/template/account/edit.twig|catalog/view/theme/*/template/account/address_form.twig">
        <operation error="skip">
            <search>
                <![CDATA[name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]"]]>
            </search>
            <add position="replace">
                <![CDATA[
                {% set custom_field_name = custom_field.name|lower|replace({' ': '_'}) %} {% if(custom_field_name == 'location_type' or custom_field_name == 'town' or custom_field_name == 'suburb') %}  name="collivery_{{ custom_field_name }}" {% else %}   name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" {% endif %}
                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.twig">
        <operation error="skip">
            <search>
                <![CDATA[<select name="custom_field[{{ custom_field.custom_field_id }}]" id="input-payment-custom-field{{ custom_field.custom_field_id }}" class="form-control">]]>
            </search>
            <add position="replace">
                <![CDATA[

                {% set custom_field_name = custom_field.name|lower|replace({' ': '_'}) %}

                {% if(custom_field_name == 'location_type' or custom_field_name == 'town' or custom_field_name == 'suburb') %}
                    <select name="payment_collivery_{{ custom_field_name }}" id="input-payment-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                {% else %}
                    <select name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" id="input-payment-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                {% endif %}

                ]]>
            </add>
        </operation>
        <operation>
            <search index="0">
                <![CDATA[<script type="text/javascript">]]>
            </search>
            <add position="before">
                <![CDATA[

<div id="collivery-confirm-create-address-modal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">

                <div class="row">
                    <div class="col-md-12">
                        <h4 style="text-align: center;">Do you want to create an address at Collivery.net for collivery shipping plugin installed</h4>
                        <p class="text-info">Please note that address will be created based on the information from the "Shipping Details" tab</p>
                        <ul>
                            <li>An address is required for a waybill to be created</li>
                            <li>Change in "Town" may affect price of a waybill</li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-left">
                        <button type="button" class="continue-to-mds-tab btn-sm btn btn-danger" data-dismiss="modal">No</button>
                    </div>
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-right">
                        <button id="yes-create-mds-address" type="button" class="continue-to-mds-tab btn-sm btn btn-success" data-dismiss="modal">Yes</button>
                    </div>
                    <div class="col-md-2"></div>
                </div>
            </div>

        </div>

    </div>
</div>
<div id="confirm-accept-price-and-create-waybill" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <h4 style="text-align: center;">
                            Do you want to create a waybill, please note the following following pricing information
                        </h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <table class="table table-stripped">
                            <thead>
                            <tr>
                                <td colspan="2">The note the following pricing details</td>
                            </tr>
                            <tr>
                                <td>Item</td>
                                <td>Value</td>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>Price Including VAT</td>
                                <td>{{ quote_data.price.inc_vat|round(2, 'floor') }}</td>
                            </tr>
                            {% for i,v in quote_data.price %}
                                <tr>
                                    <td>{{ i|upper }}</td>
                                    <td>{{ v }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-left">
                        <button type="button" class="btn-sm btn btn-danger" data-dismiss="modal">No</button>
                    </div>
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-right">
                        <button type="button" id="yes-accept-collivery" class="btn-sm btn btn-success" data-dismiss="modal">Yes</button>
                    </div>
                    <div class="col-md-2"></div>
                </div>
            </div>

        </div>

    </div>
</div>

                ]]>
            </add>
        </operation>
        <operation error="skip">
            <search index="0">
                <![CDATA[</script>]]>
            </search>
            <add position="after">
                <![CDATA[

                <script>
                    var url = (new URL(window.location.href));
                    var user_token = url.searchParams.get('user_token');
                    $(document)
                    .ready(function(){
                      ['collivery_town', 'collivery_suburb', 'collivery_location_type'].map(function(item){
                        var select = $(document).find('select[name="shipping_'+item+'"]'), option;
                        if(item === 'collivery_town'){
                          option = select.find("[value='{{ collivery_town }}']");
                        }else if(item === 'collivery_suburb'){
                          option = select.find("[value='{{ collivery_suburb }}']");
                        }else{
                          option = select.find("[value='{{ collivery_location_type }}']");
                        }
                        if(option){
                          if(option.length){
                            option.prop('selected', true);
                          }else if(!option.length && item === 'collivery_suburb'){
                            select.empty();
                          }
                        }
                        $(document)
                          .find('[name="payment_'+item+'"]')
                          .closest('div.form-group.custom-field')
                          .remove();
                      });
                      $('#input-shipping-city').closest('div.form-group').prop('hidden', 'hidden');
                    })
                    .on('click', '#dispatched-collivery-button', function(a){
                      a.preventDefault();
                      var order = url.searchParams.get('order_id');
                      var from = $('[name="collection_shipping_address_id"]').val();
                      var to = $('[name="delivery_shipping_address_id"]').val();
                      $.getJSON('index.php?route=sale/order/createCollivery&user_token='+user_token+'&order='+order+'&to='+to+'&from='+from)
                      .done(function(response){})
                      .fail(function(jqXHR, textStatus, errorThrown ) {
                        console.error(jqXHR, textStatus, errorThrown);

                        // The web server (apache, haproxy) returned an error page
                        if (jqXHR.responseText.substr(0,1) === '<') {
                          alert('Server error, please check error logs');
                        } else {
                          var text = JSON.parse(jqXHR.responseText);
                          alert(text.errors);
                        }
                      })
                    })
                    {% if not (waybill_id or waybill_status == 1) %}
                    .on('click', '#accept-waybill', function(a){
                      a.preventDefault();
                      $('#confirm-accept-price-and-create-waybill').modal('show');
                    })
                    .on('click', '#yes-accept-collivery', function(a){
                      $.ajax('index.php?route=sale/order/acceptAndCreateWaybill&user_token='+user_token+'&order_id={{ order_id }}')
                      .done(function(){
                        window.location.reload(true);
                      })
                      .fail(function(jqXHR, textStatus, errorThrown ) {
                        console.error(jqXHR, textStatus, errorThrown);

                        // The web server (apache, haproxy) returned an error page
                        if (jqXHR.responseText.substr(0,1) === '<') {
                          alert('Server error, please check error logs');
                        } else {
                          var text = JSON.parse(jqXHR.responseText);
                          alert(text.errors);
                        }
                      })
                    })
                    .on('click', '#changeFromAddress', function(a){
                        var address_id =$('#shipping_mds_default_address_id').val();
                        console.log("changeFromAddress");
                        debugger;
                      $.ajax('index.php?route=sale/order/changeFromAddress&user_token='+url.searchParams.get('user_token')+'&order_id={{ order_id }}'+'&address_id='+ address_id )
                      .done(function(){
                        var waybill_id = response.waybill_id;
                    var waybill_service = response.waybill_service;
                    var collivery_from = response.collivery_from;
                    var collivery_to = response.collivery_to;
                    var delivery_date = response.delivery_date;
                    var html = '<div class="row">' +
                        '  <div class="col-md-4 text-left">' +
                        '      <h4>' +
                        '          Waybill No: ' + waybill_id + ' <b></b>' +
                        '      </h4>' +
                        '  </div>' +
                        '  <div class="col-md-4 text-center">' +
                        '      <h4>' +
                        '          Service Type: ' + waybill_service + '<b></b>' +
                        '      </h4>' +
                        '  </div>' +
                        '  <div class="col-md-4 text-right">' +
                        '      <h4>' +
                        '          Delivery Date : ' + delivery_date + '<b></b>' +
                        '      </h4>' +
                        '    </div>' +
                        '</div>' +
                        '<div class="row">' +
                        '  <div class="col-md-12">' +
                        '    <table class="table table-bordered">' +
                        '      <tbody>' +
                        '        <tr>' +
                        '          <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>' +
                        '        </tr>' +
                        '        <tr>' +
                        '          <td width="50%" class="text-center"><b>Collection Address</b></td>' +
                        '          <td width="50%" class="text-center"><b>Delivery Address</b></td>' +
                        '        </tr>' +
                        '        <tr>' +
                        '          <td>' + collivery_from + '</td>' +
                        '          <td>' + collivery_to + '</td>' +
                        '        </tr>' +
                        '      </tbody>' +
                        '    </table>' +
                        '  </div>' +
                        '</div>';
                    $(document).find('#sub-tab-mds').html(html);
                      }).fail(function(jqXHR, textStatus, errorThrown ) {
                        console.error(jqXHR, textStatus, errorThrown);

                        // The web server (apache, haproxy) returned an error page
                        if (jqXHR.responseText.substr(0,1) === '<') {
                          alert('Server error, please check error logs');
                        } else {
                          var text = JSON.parse(jqXHR.responseText);
                          alert(text.errors);
                        }
                      })
                    })
                    {% endif %}
                    .on('click', '.continue-to-mds-tab', function(){
                      $('a[href="#tab-mds"]').tab('show');
                    })
                    .on('change', '[name="shipping_collivery_town"]', function(){
                      var elem = $(this);
                      var townId = elem.val();
                      $('[name="shipping_collivery_suburb"]').empty();

                      var city = $('#input-shipping-city');

                      city.closest('div.form-group').prop('hidden', 'hidden');

                      city.val(elem.find('option:selected').text());

                      $.ajax({
                        url: '{{ constant("HTTP_CATALOG") }}index.php?route=checkout/checkout/getTownSuburbs&town_id='+townId,
                        type: 'get',
                        success: function(respond) {
                          $('[name="shipping_collivery_suburb"]').html(respond);
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                          console.log(thrownError);
                          alert('Could not find collivery suburb, please check if this plugin is installed properly');
                        }
                      });
                    }).on('change', '[name="payment_collivery_town"]', function(){
                      var townId = $(this).val();
                      $('[name="payment_collivery_suburb"]').empty();
                      $.ajax({
                        url: '{{ constant("HTTP_CATALOG") }}index.php?route=checkout/checkout/getTownSuburbs&town_id='+townId,
                        type: 'get',
                        success: function(respond) {
                          $('[name="payment_collivery_suburb"]').html(respond);
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                          console.log(thrownError);
                          alert('Could not find collivery suburb, please check if this plugin is installed properly');
                        }
                      });
                    })
                    .on('click', '#button-mds-shipping', function(){
                      $('a[href=\'#tab-total\']').tab('show');
                    })
                    .on('click', '#yes-create-mds-address', function(){
                      var url = 'index.php?route=sale/order/createColliveryAddress&user_token='+user_token+'&order_id={{ order_id }}';

                  $.ajax({
                    url : url,
                    method:'post',
                    dataType: 'json',
                    data : $('#tab-shipping').find('select, textarea, input').serialize()
                  }).done(function(response){
                    var waybill_id = response.waybill_id;
                    var waybill_service = '';
                    var collivery_from = response.collivery_from;
                    var collivery_to = response.collivery_to;
                    var delivery_date = response.delivery_date;
                    var html = '<div class="row">' +
                      '  <div class="col-md-4 text-left">' +
                      '      <h4>' +
                      '          Waybill No: ' + waybill_id + ' <b></b>' +
                      '      </h4>' +
                      '  </div>' +
                      '  <div class="col-md-4 text-center">' +
                      '      <h4>' +
                      '          Service Type: ' + waybill_service + '<b></b>' +
                      '      </h4>' +
                      '  </div>' +
                      '  <div class="col-md-4 text-right">' +
                      '      <h4>' +
                      '          Delivery Date : ' + delivery_date + '<b></b>' +
                      '      </h4>' +
                      '    </div>' +
                      '</div>' +
                      '<div class="row">' +
                      '  <div class="col-md-12">' +
                      '    <table class="table table-bordered">' +
                      '      <tbody>' +
                      '        <tr>' +
                      '          <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>' +
                      '        </tr>' +
                      '        <tr>' +
                      '          <td width="50%" class="text-center"><b>Collection Address</b></td>' +
                      '          <td width="50%" class="text-center"><b>Delivery Address</b></td>' +
                      '        </tr>' +
                      '        <tr>' +
                      '          <td>' + collivery_from + '</td>' +
                      '          <td>' + collivery_to + '</td>' +
                      '        </tr>' +
                      '      </tbody>' +
                      '    </table>' +
                      '  </div>' +
                      '</div>';

                    $(document).find('#sub-tab-mds').html(html);
                    $('a[href=\'#tab-mds\']').tab('show');
                  })
                  .fail(function(jqXHR, textStatus, errorThrown ) {
                    console.error(jqXHR, textStatus, errorThrown);

                    // The web server (apache, haproxy) returned an error page
                    if (jqXHR.responseText.substr(0,1) === '<') {
                      alert('Server error, please check error logs');
                    } else {
                      var text = JSON.parse(jqXHR.responseText);
                      alert(text.errors);
                    }
                  });
                });
                </script>

                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.twig">
        <operation error="skip">
            <search>
                <![CDATA[<select name="custom_field[{{ custom_field.custom_field_id }}]" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control">]]>
            </search>
            <add position="replace">
                <![CDATA[

                {% set custom_field_name = custom_field.name|lower|replace({' ': '_'}) %}

                {% if(custom_field_name == 'location_type' or custom_field_name == 'town' or custom_field_name == 'suburb') %}
                    <select name="shipping_collivery_{{ custom_field_name }}" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control"
                    {% else %}
                    <select name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                    {% endif %}

                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/model/account/custom_field.php">
        <operation>
            <search>
                <![CDATA[foreach ($custom_field_value_query->rows as $custom_field_value) {]]>
            </search>
            <add position="before">
                <![CDATA[

            /** @collivery-data **/

                if($this->collivery && !$this->collivery->hasErrors()){
                    if($custom_field['name'] === 'Location Type' || $custom_field['name'] === 'Town' || $custom_field['name'] === 'Suburb'){
                        $custom_field_value_query->rows = [];
                        if($custom_field['name'] == 'Location Type'){
                            $data_array = $location_types;
                        }elseif ($custom_field['name'] == 'Town'){
                            $data_array = $towns;
                        }else{
                            $data_array = $suburbs;
                        }
                        foreach ($data_array as $id => $name){
                            $custom_field_value_query->rows[] = ['custom_field_value_id' => $id, 'name' => $name];
                        }
                    }
                }
               /** @endcollivery-data **/

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[foreach ($custom_field_query->rows as $custom_field) {]]>
            </search>
            <add position="before">
                <![CDATA[

       /** @collivery-data **/
       if($this->collivery){
            $location_types = $this->collivery->getLocationTypes();
            $towns = $this->collivery->getTowns();
            $suburbs = $this->collivery->getAllSuburbs();
        }
       /** @endcollivery-data **/

                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/model/customer/custom_field.php">
        <operation>
            <search index="0">
                <![CDATA[$custom_field_value_data = array();]]>
            </search>
            <add position="after">
                <![CDATA[

            /** @collivery-data **/
        $query = $this->db->query("select * from " . DB_PREFIX . "custom_field_description where custom_field_id='". $this->db->escape($custom_field_id) . "'");
        if($query->num_rows){
            if($query->row['name'] === 'Town' || $query->row['name'] === 'Suburb' || $query->row['name'] === 'Location Type' && $this->collivery && !$this->collivery->hasErrors()){
                $locationtype = $this->collivery->getLocationTypes();
                $town = $this->collivery->getTowns();
                $suburb = $this->collivery->getAllSuburbs();
                $data = ${str_replace(' ', '', strtolower($query->row['name']))};
                foreach($data as $key => $val){
                    $custom_field_value_data[$key] = [
                        'custom_field_value_id' => $key,
                        'name'                  => $val
                    ];
                }
            }
            return $custom_field_value_data;
        }
               /** @endcollivery-data **/

                ]]>
            </add>
        </operation>
    </file>
    <!-- End Catalog Views -->
    <!-- END VIEWS -->
</modification>
